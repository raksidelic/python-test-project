stages:
  - test
  - report

spec:
  inputs:
    video_mode:
      description: "Video KayÄ±t Stratejisi"
      default: "on_failure"
      options:
        - "true"
        - "false"
        - "on_failure"

variables:
  # Python'un bytecode (.pyc) oluÅŸturmasÄ±nÄ± engeller
  PYTHONDONTWRITEBYTECODE: "1"
  # Video ve Screenshot ayarlarÄ±
  RECORD_VIDEO: $[[ inputs.video_mode ]]
  TAKE_SCREENSHOT: "true"

run_tests:
  stage: test
  image: docker:latest
  tags:
    - mac-m3-runner
  
  script:
    # 1. BAÄIMLILIKLARI YÃœKLE
    - apk add --no-cache python3 py3-pip docker-compose

    # 2. ORTAM (.env) DOSYASINI HAZIRLA
    - echo "ARANGO_URL=http://arangoDB:8529" > .env
    - echo "ARANGO_DB_NAME=$ARANGO_DB_NAME" >> .env
    - echo "ARANGO_USER=$ARANGO_USER" >> .env
    - echo "ARANGO_PASSWORD=$ARANGO_PASSWORD" >> .env
    - echo "Ortam dosyasÄ± oluÅŸturuldu."

    - echo "RECORD_VIDEO=$RECORD_VIDEO" >> .env
    
    # 3. AÄ AYARLARI
    - docker network create shared-network || true
    - docker network connect shared-network arangoDB || true
    
    # 4. KLASÃ–R Ä°ZÄ°NLERÄ°
    - mkdir -p videos allure-results logs
    - chmod -R 777 videos allure-results logs
    
    # 5. AKILLI BAÅLATMA ğŸš€
    # Mimarisi ne olursa olsun (ARM/Intel), doÄŸru dosyayÄ± python scripti seÃ§er.
    - python3 start_tests.py

  after_script:
    # DÃœZELTME: Global deÄŸiÅŸken yerine, temizlik sÄ±rasÄ±nda hatayÄ± susturmak iÃ§in
    # 'ignore_me' gibi Ã¶nemsiz bir deÄŸer atÄ±yoruz. 
    # 'down' komutu konfigÃ¼rasyon dosyasÄ±nÄ±n iÃ§eriÄŸiyle ilgilenmez.
    - BROWSERS_JSON=ignore_me docker-compose down --remove-orphans

  artifacts:
    when: always
    paths:
      - allure-results/
      - videos/
      - logs/
    expire_in: 3 days

generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  tags:
    - mac-m3-runner
  script:
     - allure generate -c allure-results -o allure-report
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  needs:
    - run_tests
  when: always