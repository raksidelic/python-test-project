stages:
  - test
  - report

variables:
  # GitLab Settings'den gelenler dÄ±ÅŸÄ±nda:
  PYTHONDONTWRITEBYTECODE: "1"
  # after_script'in boÅŸ kalÄ±p hata vermemesi iÃ§in varsayÄ±lan bir deÄŸer:
  BROWSERS_JSON: "browsers_intel.json"
  # Video kaydÄ± ayarlarÄ± (start_tests.py iÃ§indeki mantÄ±kla uyumlu Ã§alÄ±ÅŸÄ±r)
  RECORD_VIDEO: "on_failure"
  TAKE_SCREENSHOT: "true"

run_tests:
  stage: test
  image: docker:latest
  tags:
    - mac-m3-runner

  script:
    # 1. BAÄIMLILIKLARI YÃœKLE (Python HatasÄ±nÄ±n Ã‡Ã¶zÃ¼mÃ¼)
    # docker:latest imajÄ± boÅŸtur, iÃ§ine python3 ve docker-compose kuruyoruz.
    - apk add --no-cache python3 py3-pip docker-compose

    # 2. ORTAM (.env) DOSYASINI HAZIRLA (Stabil sÃ¼rÃ¼mden alÄ±ndÄ±)
    - echo "ARANGO_URL=http://arangoDB:8529" > .env
    - echo "ARANGO_DB_NAME=$ARANGO_DB_NAME" >> .env
    - echo "ARANGO_USER=$ARANGO_USER" >> .env
    - echo "ARANGO_PASSWORD=$ARANGO_PASSWORD" >> .env
    - echo "Ortam dosyasÄ± oluÅŸturuldu."
    
    # 3. AÄ AYARLARI (Stabil sÃ¼rÃ¼mden alÄ±ndÄ± - Kritik!)
    # DÄ±ÅŸarÄ±daki 'arangoDB' container'Ä±nÄ± test aÄŸÄ±na baÄŸlÄ±yoruz.
    - docker network create shared-network || true
    - docker network connect shared-network arangoDB || true
    
    # 4. KLASÃ–R Ä°ZÄ°NLERÄ°
    - mkdir -p videos allure-results logs
    - chmod -R 777 videos allure-results logs
    
    # 5. AKILLI BAÅLATMA ğŸš€
    # - Ä°ÅŸlemci mimarisini algÄ±lar (ARM vs Intel)
    # - DoÄŸru imajlarÄ± (Seleniarm vs Selenoid) indirir
    # - docker-compose up komutunu Ã§alÄ±ÅŸtÄ±rÄ±r ve test sonucunu bildirir
    - python3 start_tests.py

  after_script:
    # Test bitince temizlik yap (VarsayÄ±lan deÄŸiÅŸken ile Ã§alÄ±ÅŸÄ±r)
    - docker-compose down --remove-orphans

  artifacts:
    when: always
    paths:
      - allure-results/
      - videos/
      - logs/
    expire_in: 3 days

generate_report:
  stage: report
  image: frankescobar/allure-docker-service
  tags:
    - mac-m3-runner
  script:
     - allure generate -c allure-results -o allure-report
  artifacts:
    paths:
      - allure-report/
    expire_in: 1 week
  needs:
    - run_tests
  when: always